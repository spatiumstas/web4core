name: Validate & Deploy

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  validate-singbox:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install JS deps
        run: npm ci --no-fund --no-audit

      - name: Build web runtime (web4core.runtime.js)
        run: npm run build:web

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          cache: false
          go-version: '1.21'

      - name: Download sing-box
        run: |
          # Get latest release info
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest)
          DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("linux-amd64.tar.gz")) | .browser_download_url')
          VERSION=$(echo $LATEST_RELEASE | jq -r '.tag_name')
          
          echo "Downloading sing-box $VERSION from $DOWNLOAD_URL"
          wget -O sing-box.tar.gz "$DOWNLOAD_URL"
          tar -xzf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          chmod +x /usr/local/bin/sing-box

      - name: Generate and validate sing-box configs
        env:
          CONFIGS: ${{ secrets.CONFIGS }}
          WG_CONF: ${{ secrets.WG_CONF }}
        run: node tools/ci/validate-singbox.js

  validate-singbox-extended:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install JS deps
        run: npm ci --no-fund --no-audit

      - name: Build web runtime (web4core.runtime.js)
        run: npm run build:web

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          cache: false
          go-version: '1.21'

      - name: Download sing-box extended
        run: |
          # Get latest release info
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/shtorm-7/sing-box-extended/releases/latest)
          DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("linux-amd64.tar.gz")) | .browser_download_url')
          VERSION=$(echo $LATEST_RELEASE | jq -r '.tag_name')
          
          echo "Downloading sing-box extended $VERSION from $DOWNLOAD_URL"
          wget -O sing-box-extended.tar.gz "$DOWNLOAD_URL"
          tar -xzf sing-box-extended.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/sing-box-extended
          chmod +x /usr/local/bin/sing-box-extended


      - name: Run Extended Configs with sing-box extended
        env:
          CONFIGS: ${{ secrets.CONFIGS }}
          MIERU_JSON: ${{ secrets.MIERU_JSON }}
          SDNS_LINK: ${{ secrets.SDNS_LINK }}
          XHTTP_LINK: ${{ secrets.XHTTP_LINK }}
        run: node tools/ci/validate-singbox-extended.js

  validate-xray:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install JS deps
        run: npm ci --no-fund --no-audit

      - name: Build web runtime (web4core.runtime.js)
        run: npm run build:web

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          cache: false
          go-version: '1.21'

      - name: Download Xray
        run: |
          # Get latest release info
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest)
          DOWNLOAD_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name == "Xray-linux-64.zip") | .browser_download_url')
          VERSION=$(echo $LATEST_RELEASE | jq -r '.tag_name')
          
          echo "Downloading Xray $VERSION from $DOWNLOAD_URL"
          wget -O xray.zip "$DOWNLOAD_URL"
          rm -rf /tmp/xray && mkdir -p /tmp/xray
          unzip -q xray.zip -d /tmp/xray
          sudo mv /tmp/xray/xray /usr/local/bin/
          chmod +x /usr/local/bin/xray

      - name: Generate and validate Xray configs
        env:
          CONFIGS: ${{ secrets.CONFIGS }}
        run: node tools/ci/validate-xray.js

  validate-mihomo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install JS deps
        run: npm ci --no-fund --no-audit

      - name: Build web runtime (web4core.runtime.js)
        run: npm run build:web

      - name: Download Mihomo
        run: |
          set -e
          API_JSON=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)
          VERSION=$(echo "$API_JSON" | jq -r '.tag_name')
          echo "Latest Mihomo version: $VERSION"

          # Prefer linux-amd64 .gz assets (v3 > v2 > v1)
          URL=$(echo "$API_JSON" | jq -r '
            (
              .assets[] | select(.name | test("^mihomo-linux-amd64-v3-.*\\.gz$")) | .browser_download_url
            ),(
              .assets[] | select(.name | test("^mihomo-linux-amd64-v2-.*\\.gz$")) | .browser_download_url
            ),(
              .assets[] | select(.name | test("^mihomo-linux-amd64-v1-.*\\.gz$")) | .browser_download_url
            ) | select(.!=null) | .  ' | head -n1)
          if [[ -z "$URL" ]]; then echo "Failed to resolve Mihomo download URL"; exit 1; fi
          echo "Downloading Mihomo from $URL"
          wget -O /tmp/mihomo.dl "$URL"
          # All selected artifacts are .gz: write decompressed binary
          gunzip -c /tmp/mihomo.dl | sudo tee /usr/local/bin/mihomo >/dev/null
          sudo chmod +x /usr/local/bin/mihomo

      - name: Generate and validate Mihomo configs
        env:
          CONFIGS: ${{ secrets.CONFIGS }}
          WG_CONF: ${{ secrets.WG_CONF }}
        run: node tools/ci/validate-mihomo.js

  build:
    runs-on: ubuntu-latest
    needs: [ validate-singbox, validate-singbox-extended, validate-xray, validate-mihomo ]
    if: github.ref == 'refs/heads/main'

    concurrency:
      group: "pages"
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Build static site
        run: |
          set -euo pipefail
          npm ci --no-fund --no-audit
          npm run build:web
          mkdir -p _site
          cp -r src/* _site/
          SHA="${GITHUB_SHA::7}"
          export SHA
          ASSETS=("web4core.runtime.js" "ui.js" "style.css" "favicon.png")
          for f in "${ASSETS[@]}"; do
            src="_site/$f"
            [ -f "$src" ] || continue
            ext="${f##*.}"
            base="${f%.*}"
            mv "$src" "_site/${base}-${SHA}.${ext}"
          done
          node -e 'const fs=require("fs"); const sha=process.env.SHA||""; if(!sha) throw new Error("Missing SHA env"); const files=["style.css","web4core.runtime.js","ui.js","favicon.png"]; let s=fs.readFileSync("_site/index.html","utf8"); for(const f of files){ const i=f.lastIndexOf("."); const base=i>=0?f.slice(0,i):f; const ext=i>=0?f.slice(i+1):""; const to=ext?(base+"-"+sha+"."+ext):(base+"-"+sha); s=s.split(f).join(to); } fs.writeFileSync("_site/index.html", s);'
          echo "$SHA" > _site/version.txt
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-worker-api:
    name: Deploy Cloudflare Worker
    runs-on: ubuntu-latest
    needs: [ validate-singbox, validate-singbox-extended, validate-xray, validate-mihomo ]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install JS deps
        run: npm ci --no-fund --no-audit

      - name: Build worker bundle
        run: npm run build:worker

      - name: Deploy worker with Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/api
          wranglerVersion: '4.54.0'
          command: deploy
